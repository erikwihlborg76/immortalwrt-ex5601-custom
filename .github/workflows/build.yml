name: immortalwrt-build-ex5601

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      # ---- IMMORTALWRT SOURCE ----
      REPO_URL: "https://github.com/padavanonly/immortalwrt-mt798x-24.10"
      BRANCH: "openwrt-24.10-6.6"

      # ---- TARGET / PROFILE ----
      OWRT_TARGET: "mediatek"
      OWRT_SUBTARGET: "filogic"
      PROFILE: "zyxel_ex5601-t0-ubootmod"

      # Work directory for sources
      WORKDIR: "${{ github.workspace }}/openwrt"

    steps:
      - name: Checkout build repo
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3 python3-distutils rsync unzip zlib1g-dev file wget \
            subversion swig libpython3-dev ccache

      - name: Fetch ImmortalWrt sources
        run: |
          git -c advice.detachedHead=false clone \
            --single-branch --branch "${BRANCH}" \
            --depth 1 --filter=blob:none \
            "${REPO_URL}" "${WORKDIR}"

      - name: Optional custom feeds.conf
        if: hashFiles('feeds.conf.custom') != ''
        run: |
          cp feeds.conf.custom "${WORKDIR}/feeds.conf.default"

      - name: Update & install feeds
        run: |
          cd "${WORKDIR}"
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Apply tree-level patches (if any)
        if: hashFiles('patches/**/*.patch') != ''
        run: |
          cd "${WORKDIR}"
          for p in "${GITHUB_WORKSPACE}"/patches/*.patch; do
            echo "Applying $(basename "$p")"
            patch -p1 < "$p"
          done

      - name: Apply per-package patches (if any)
        if: hashFiles('package-patches/**') != ''
        run: |
          rsync -a "${GITHUB_WORKSPACE}/package-patches/" "${WORKDIR}/" || true

      - name: Inject .config
        run: |
          cd "${WORKDIR}"
          cp "${GITHUB_WORKSPACE}/configs/${PROFILE}.config" .config
          make defconfig

      - name: Overlay files/ (optional)
        run: |
          if [ -d "${GITHUB_W_]()
